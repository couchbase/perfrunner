---
- hosts: kv:index:n1ql:analytics:eventing
  vars:
    couchbase_home: /opt/couchbase
    data_dir: /data
    index_dir: /index
  tasks:
  - name: killing the processes
    shell: 'killall -I -g -q -s SIGKILL {{item}} || true'
    with_items:
      - epmd
      - beam.smp
      - cbq-engine
      - cbft
      - couch_view_index_updater
      - goport
      - goxdcr
      - java
      - indexer
      - memcached
      - moxi
      - mongod
      - mongos
      - mysqld
      - sync_gateway

  - name: killing the processes on ports
    shell: "lsof -t -i:'{{item}}' -sTCP:LISTEN | xargs kill -9 || true"
    with_items:
      - 9100
      - 9101
      - 9102
      - 9103
      - 9104
      - 9105
      - 9999

  - name: uninstalling the database packages
    yum:
     state: absent
     name:
      - 'couchbase*'
      - 'mongodb*'
      - 'MariaDB*'

  - name: removing Couchbase Server files
    file: path={{ couchbase_home }} state=absent

  - name: removing the files remaining in the "{{ data_dir }}" directory
    shell: rm -fr {{ data_dir }}/*
    args:
      warn: no

  - stat: path={{ index_dir }}
    register: index

  - name: removing the files remaining in the "{{ index_dir }}" directory
    shell: rm -fr {{ index_dir }}/*
    when: index.stat.exists
    args:
      warn: no

  - name: removing MySQL installation (if any)
    shell: rm -fr /var/lib/mysql
    args:
      warn: no

  - name: set vm.swappiness to 0
    shell: "echo 0 > /proc/sys/vm/swappiness"

  - name: disable thp
    shell: "echo never > /sys/kernel/mm/transparent_hugepage/enabled"